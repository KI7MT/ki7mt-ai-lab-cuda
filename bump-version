#!/bin/bash
set -e

# Purpose: Bump version and create git tag for rpkg builds
# Usage: ./bump-version <new-version>
# Example: ./bump-version 1.0.5
#
# This script:
#   1. Updates the VERSION file
#   2. Updates the spec file Version: line
#   3. Commits the changes
#   4. Creates a git tag (vX.Y.Z format)

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
VERSION_FILE="$SCRIPT_DIR/VERSION"
SPEC_FILE="$SCRIPT_DIR/ki7mt-ai-lab-core.spec"

if [[ -z "$1" ]]; then
    printf "Usage: %s <new-version>\n" "$(basename "$0")"
    printf "Example: %s 1.0.5\n" "$(basename "$0")"
    printf "\nCurrent version: %s\n" "$(cat "$VERSION_FILE" 2>/dev/null || echo 'unknown')"
    exit 1
fi

NEW_VERSION="$1"

# Validate version format (X.Y.Z)
if ! [[ "$NEW_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    printf "Error: Version must be in X.Y.Z format (e.g., 1.0.5)\n" >&2
    exit 1
fi

# Update VERSION file
printf "%s\n" "$NEW_VERSION" > "$VERSION_FILE"
printf "Updated VERSION to %s\n" "$NEW_VERSION"

# Update spec file Version: line
if [[ -f "$SPEC_FILE" ]]; then
    sed -i "s/^Version:.*$/Version:        ${NEW_VERSION}/" "$SPEC_FILE"
    printf "Updated spec file to %s\n" "$NEW_VERSION"
fi

# Stage and commit
git add "$VERSION_FILE" "$SPEC_FILE"
git commit -m "v${NEW_VERSION}: version bump"

# Create tag
git tag -a "v${NEW_VERSION}" -m "Release v${NEW_VERSION}"

printf "\nVersion bump complete!\n"
printf "  VERSION file: %s\n" "$NEW_VERSION"
printf "  Spec file:    %s\n" "$NEW_VERSION"
printf "  Git tag:      v%s\n" "$NEW_VERSION"
printf "\nTo push: git push && git push --tags\n"
